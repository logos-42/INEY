<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸª™ INEY äº¤æ˜“</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¤šä¸ªethers.js CDNæºï¼Œç¡®ä¿åŠ è½½æˆåŠŸ -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="text/javascript"></script>
    <script>
        // å¦‚æœethersåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨CDN
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>');
        }
    </script>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #0052ff 0%, #1652f0 100%);
            color: white;
            padding: 60px 0;
        }
        .trade-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }
        .token-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .price-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .btn-primary-custom {
            background: linear-gradient(135deg, #0052ff 0%, #1652f0 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 8px;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 82, 255, 0.3);
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- ç½‘ç»œçŠ¶æ€æ˜¾ç¤º -->
    <div id="networkStatus" class="network-status"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">ğŸª™ INEY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">é¦–é¡µ</a></li>
                    <li class="nav-item"><a class="nav-link" href="create.html">åˆ›å»ºä»£å¸</a></li>
                    <li class="nav-item"><a class="nav-link active" href="tread.html">äº¤æ˜“</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">ä»ªè¡¨æ¿</a></li>
                </ul>
            </div>
            <button id="connect-wallet" class="btn btn-primary">è¿æ¥é’±åŒ…</button>
        </div>
    </nav>

    <!-- è‹±é›„åŒºåŸŸ -->
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-6 fw-bold mb-3">ğŸš€ ä»£å¸äº¤æ˜“</h1>
            <p class="lead">åœ¨Baseä¸»ç½‘ä¸Šäº¤æ˜“ä¸ªäººä»£å¸</p>
        </div>
    </section>

    <!-- äº¤æ˜“ç•Œé¢ -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="trade-card">
                    <!-- ä»£å¸é€‰æ‹© -->
                    <div class="row mb-4">
            <div class="col-md-6">
                            <h5><i class="fas fa-coins me-2"></i>é€‰æ‹©ä»£å¸</h5>
                <select id="token-select" class="form-control">
                    <option value="">-- é€‰æ‹©ä»£å¸ --</option>
                </select>
                            <div class="form-text">é€‰æ‹©è¦äº¤æ˜“çš„ä»£å¸</div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-sync-alt me-2"></i>åˆ·æ–°æ•°æ®</h5>
                            <button id="refresh-tokens" class="btn btn-outline-primary me-2" onclick="loadAllTokens()">
                                <i class="fas fa-refresh me-1"></i>åˆ·æ–°ä»£å¸åˆ—è¡¨
                            </button>
                            <button id="create-test-pool" class="btn btn-outline-success me-2" onclick="showCreatePoolModal()">
                                <i class="fas fa-plus me-1"></i>åˆ›å»ºæµ‹è¯•æ± 
                            </button>
                            <button class="btn btn-outline-info" onclick="showAddTokenModal()">
                                <i class="fas fa-coin me-1"></i>æ·»åŠ ä»£å¸
                            </button>
            </div>
        </div>

                    <!-- ä»£å¸ä¿¡æ¯æ˜¾ç¤º -->
                    <div id="token-info" class="token-info" style="display: none;">
                        <h6><i class="fas fa-info-circle me-2"></i>ä»£å¸ä¿¡æ¯</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>åç§°:</strong><br>
                                <span id="token-name">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ç¬¦å·:</strong><br>
                                <span id="token-symbol">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ä½™é¢:</strong><br>
                                <span id="token-balance">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>æµåŠ¨æ€§æ± :</strong><br>
                                <span id="pool-status">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ä»·æ ¼ä¿¡æ¯ -->
                    <div id="price-info" class="price-info" style="display: none;">
                        <h6><i class="fas fa-chart-line me-2"></i>ä»·æ ¼ä¿¡æ¯</h6>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <strong>Tokenå‚¨å¤‡:</strong><br>
                                <span id="token-reserve">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>ETHå‚¨å¤‡:</strong><br>
                                <span id="eth-reserve">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>ä»·æ ¼:</strong><br>
                                <span id="token-price">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤æ˜“é¢æ¿ -->
                    <div id="trade-panel" style="display: none;">
                        <h4 class="mb-3">äº¤æ˜“ <span id="selected-token-name"></span> (<span id="selected-token-symbol"></span>)</h4>
                        
                        <!-- äº¤æ˜“ç±»å‹é€‰æ‹© -->
                        <div class="form-group mb-3">
                            <label class="form-label">äº¤æ˜“ç±»å‹</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="buy-btn">
                                    <i class="fas fa-arrow-down me-1"></i>è´­ä¹°ä»£å¸ (ETH â†’ Token)
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="sell-btn">
                                    <i class="fas fa-arrow-up me-1"></i>å‡ºå”®ä»£å¸ (Token â†’ ETH)
                                </button>
                            </div>
                        </div>

                        <!-- è¾“å…¥æ•°é‡ -->
                        <div class="form-group mb-3">
                            <label id="amount-label" class="form-label">è¾“å…¥ETHæ•°é‡</label>
                            <div class="input-group">
                                <input type="number" id="amount-input" class="form-control" placeholder="0.0" step="0.001" min="0">
                                <span class="input-group-text" id="input-currency">ETH</span>
                            </div>
                            <div class="form-text">è¾“å…¥è¦äº¤æ˜“çš„æ•°é‡</div>
                        </div>

                        <!-- é¢„ä¼°è¾“å‡º -->
                        <div class="form-group mb-3">
                            <label class="form-label">é¢„ä¼°è·å¾—</label>
                            <div class="input-group">
                        <input type="text" id="estimate-output" class="form-control" readonly>
                                <span class="input-group-text" id="output-currency">Token</span>
                            </div>
                            <div class="form-text">é¢„è®¡å¯ä»¥è·å¾—çš„æ•°é‡ï¼ˆå·²æ‰£é™¤0.3%æ‰‹ç»­è´¹ï¼‰</div>
                        </div>

                        <!-- æ»‘ç‚¹è®¾ç½® -->
                        <div class="form-group mb-3">
                            <label class="form-label">æ»‘ç‚¹å®¹å¿åº¦</label>
                            <select id="slippage-select" class="form-control">
                                <option value="0.5">0.5%</option>
                                <option value="1" selected>1%</option>
                                <option value="3">3%</option>
                                <option value="5">5%</option>
                            </select>
                        </div>

                        <!-- æ‰§è¡Œäº¤æ˜“æŒ‰é’® -->
                        <button id="trade-button" class="btn btn-primary-custom w-100 mb-3" disabled>
                            <i class="fas fa-exchange-alt me-2"></i>æ‰§è¡Œäº¤æ˜“
                        </button>

                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div class="loading-spinner" id="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">å¤„ç†ä¸­...</span>
                            </div>
                            <p class="mt-3">æ­£åœ¨å¤„ç†äº¤æ˜“ï¼Œè¯·ç¨å€™...</p>
                        </div>
                    </div>

                                         <!-- æç¤ºä¿¡æ¯ -->
                     <div class="alert alert-warning">
                         <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>é‡è¦è¯´æ˜</h6>
                         <ul class="mb-0">
                             <li>è¯·å…ˆè¿æ¥MetaMaské’±åŒ…å¹¶ç¡®ä¿åœ¨Baseä¸»ç½‘</li>
                             <li>æ‚¨çš„SimpleTokenFactory(0x09F8...f468)åªè®°å½•ä»£å¸åˆ›å»ºè¯·æ±‚</li>
                             <li>å®é™…ä»£å¸éœ€è¦æ‚¨å•ç‹¬éƒ¨ç½²ï¼Œç„¶åä½¿ç”¨"æ·»åŠ ä»£å¸"åŠŸèƒ½æ·»åŠ </li>
                             <li>åªæ·»åŠ é€šè¿‡æ‚¨çš„ç³»ç»Ÿåˆ›å»ºçš„ä»£å¸ï¼Œé¿å…å®‰å…¨é£é™©</li>
                             <li>äº¤æ˜“éœ€è¦æ”¯ä»˜0.3%çš„æ‰‹ç»­è´¹</li>
                             <li>å»ºè®®è®¾ç½®é€‚å½“çš„æ»‘ç‚¹å®¹å¿åº¦</li>
                         </ul>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæµåŠ¨æ€§æ± æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createPoolModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºæµ‹è¯•æµåŠ¨æ€§æ± </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>æ³¨æ„:</strong> è¿™å°†ä½¿ç”¨çœŸå®çš„ETHåˆ›å»ºæµåŠ¨æ€§æ± ï¼
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">é€‰æ‹©ä»£å¸</label>
                        <select id="pool-token-select" class="form-control">
                            <option value="">-- é€‰æ‹©ä»£å¸ --</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">ä»£å¸æ•°é‡</label>
                        <input type="number" id="pool-token-amount" class="form-control" placeholder="1000" min="1">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">ETHæ•°é‡</label>
                        <input type="number" id="pool-eth-amount" class="form-control" placeholder="0.001" step="0.001" min="0.001">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createPool()">åˆ›å»ºæ± </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ä»£å¸æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addTokenModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ çœŸå®ä»£å¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>é‡è¦è¯´æ˜</h6>
                        <ul class="mb-0">
                            <li>SimpleTokenFactoryåªè®°å½•ä»£å¸åˆ›å»ºè¯·æ±‚</li>
                            <li>å®é™…ä»£å¸éœ€è¦æ‚¨å•ç‹¬éƒ¨ç½²</li>
                            <li>è¯·ç¡®ä¿ä»£å¸åœ°å€æ˜¯é€šè¿‡æ‚¨çš„ç³»ç»Ÿåˆ›å»ºçš„</li>
                            <li>æ·»åŠ ä¸æ˜ä»£å¸å­˜åœ¨å®‰å…¨é£é™©</li>
                        </ul>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">ä»£å¸åˆçº¦åœ°å€</label>
                        <input type="text" id="token-address-input" class="form-control" placeholder="0x..." maxlength="42">
                        <div class="form-text">è¾“å…¥å·²éƒ¨ç½²çš„ä»£å¸åˆçº¦åœ°å€</div>
                    </div>
                    <div id="token-verification" class="alert" style="display: none;">
                        <!-- ä»£å¸éªŒè¯ç»“æœ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-info" onclick="verifyToken()">éªŒè¯ä»£å¸</button>
                    <button type="button" class="btn btn-primary" onclick="addToken()" disabled id="add-token-btn">æ·»åŠ ä»£å¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultTitle">äº¤æ˜“ç»“æœ</h5>
                </div>
                <div class="modal-body" id="resultBody">
                    <!-- ç»“æœå†…å®¹ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="location.reload()">ç»§ç»­äº¤æ˜“</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç½‘ç»œé…ç½®
        const NETWORK_CONFIG = {
            chainId: 8453,
            name: "Base Mainnet",
            rpcUrl: "https://mainnet.base.org",
            explorer: "https://basescan.org",
            contracts: {
                SimpleTokenFactory: "0x09F80281c90d574B4C5769cf2308ea4B70b4f468",
                PersonalToken: "0xd3F54d1e5909a8ae1E15DBf1e27825e716B26d0E",
                SimpleAMM: "0x8C53A213B97B52989BCCE04fE306464e6767BC75"
            }
        };

        // åˆçº¦ABI
        const SIMPLE_TOKEN_FACTORY_ABI = [
            "function totalTokensCreated() external view returns (uint256)",
            "function getUserTokenCount(address user) external view returns (uint256)",
            "function creationFee() external view returns (uint256)",
            "function requestTokenCreation(string memory _name, string memory _symbol, uint256 _initialSupply) external payable returns (bool)"
        ];

        const SIMPLE_AMM_ABI = [
            "function getAllPoolTokens() external view returns (address[])",
            "function getPoolInfo(address token) external view returns (uint256 tokenReserve, uint256 ethReserve, uint256 totalLiquidity, bool exists)",
            "function buyToken(address token, uint256 minTokenOut) external payable",
            "function sellToken(address token, uint256 tokenAmount, uint256 minEthOut) external",
            "function createPool(address token, uint256 tokenAmount) external payable",
            "function getPrice(address token) external view returns (uint256 tokenPrice, uint256 ethPrice)",
            "function getAmountOut(uint256 amountIn, uint256 reserveIn, uint256 reserveOut) external pure returns (uint256)"
        ];

        const ERC20_ABI = [
            "function name() external view returns (string)",
            "function symbol() external view returns (string)",
            "function decimals() external view returns (uint8)",
            "function totalSupply() external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function transfer(address to, uint256 amount) external returns (bool)"
        ];

        let provider, signer, userAccount;
        let simpleTokenFactoryContract, simpleAMMContract;
        let currentTradeType = 'buy';
        let selectedToken = null;

        // ç¡®ä¿ethersåº“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
        function initializeApp() {
            if (typeof ethers === 'undefined') {
                console.error('ethersåº“æœªåŠ è½½ï¼Œç­‰å¾…é‡è¯•...');
                setTimeout(initializeApp, 500);
                return;
            }
            
            console.log('ethersåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', ethers.version);
            initializeWeb3();
            setupEventListeners();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 100);
        });

        // åˆå§‹åŒ–Web3
        async function initializeWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                    const accounts = await window.ethereum.request({method: 'eth_accounts'});
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–Web3å¤±è´¥:', error);
                    showNetworkStatus('error', 'åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            } else {
                showNetworkStatus('warning', 'è¯·å®‰è£…MetaMaské’±åŒ…');
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNetworkStatus('error', 'è¯·å®‰è£…MetaMaské’±åŒ…');
                    return;
                }

                console.log('å¼€å§‹è¿æ¥é’±åŒ…...');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (!accounts || accounts.length === 0) {
                    showNetworkStatus('error', 'æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·ï¼Œè¯·æ£€æŸ¥MetaMask');
                    return;
                }
                
                userAccount = accounts[0];
                
                if (!provider) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                
                try {
                signer = provider.getSigner();
                } catch (signerError) {
                    console.error('è·å–Signerå¤±è´¥:', signerError);
                    showNetworkStatus('error', 'è·å–ç­¾åå™¨å¤±è´¥: ' + signerError.message);
                    return;
                }

                // æ£€æŸ¥ç½‘ç»œ
                try {
                const network = await provider.getNetwork();
                    
                if (network.chainId !== NETWORK_CONFIG.chainId) {
                        await switchToBaseMainnet();
                        return;
                    }
                } catch (networkError) {
                    console.error('è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥:', networkError);
                    showNetworkStatus('warning', 'æ— æ³•è·å–ç½‘ç»œä¿¡æ¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                }
                
                // åˆå§‹åŒ–åˆçº¦å®ä¾‹
                try {
                    simpleTokenFactoryContract = new ethers.Contract(
                        NETWORK_CONFIG.contracts.SimpleTokenFactory,
                        SIMPLE_TOKEN_FACTORY_ABI,
                        provider
                    );
                    
                    simpleAMMContract = new ethers.Contract(
                        NETWORK_CONFIG.contracts.SimpleAMM,
                        SIMPLE_AMM_ABI,
                        signer
                    );
                } catch (contractError) {
                    console.error('åˆ›å»ºåˆçº¦å®ä¾‹å¤±è´¥:', contractError);
                    showNetworkStatus('error', 'åˆ›å»ºåˆçº¦å®ä¾‹å¤±è´¥: ' + contractError.message);
                    return;
                }
                
                showNetworkStatus('success', `å·²è¿æ¥: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}`);
                updateConnectButton(true);
                
                // åŠ è½½ä»£å¸æ•°æ®
                await loadAllTokens();
                
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…è¯¦ç»†é”™è¯¯:', error);
                
                let errorMessage = 'è¿æ¥å¤±è´¥';
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                } else if (error.code === -32002) {
                    errorMessage = 'MetaMaskæ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·ç­‰å¾…';
                } else if (error.message) {
                    errorMessage = 'è¿æ¥å¤±è´¥: ' + error.message;
                } else {
                    errorMessage = 'è¿æ¥å¤±è´¥: æœªçŸ¥é”™è¯¯';
                }
                
                showNetworkStatus('error', errorMessage);
            }
        }

        // åˆ‡æ¢åˆ°Baseä¸»ç½‘
        async function switchToBaseMainnet() {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + NETWORK_CONFIG.chainId.toString(16) }],
                        });
                
                setTimeout(connectWallet, 1000);
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await addBaseMainnetNetwork();
                } else {
                    throw switchError;
                }
            }
        }

        // æ·»åŠ Baseä¸»ç½‘
        async function addBaseMainnetNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x' + NETWORK_CONFIG.chainId.toString(16),
                        chainName: NETWORK_CONFIG.name,
                        nativeCurrency: {
                            name: 'ETH',
                            symbol: 'ETH',
                            decimals: 18,
                        },
                        rpcUrls: [NETWORK_CONFIG.rpcUrl],
                        blockExplorerUrls: [NETWORK_CONFIG.explorer],
                    }],
                });
                
                setTimeout(connectWallet, 1000);
                
            } catch (error) {
                console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', error);
                showNetworkStatus('error', 'æ·»åŠ ç½‘ç»œå¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ‰€æœ‰ä»£å¸
        async function loadAllTokens() {
            if (!provider || !simpleAMMContract) {
                showNetworkStatus('warning', 'è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            try {
                showNetworkStatus('info', 'æ­£åœ¨åŠ è½½ä»£å¸åˆ—è¡¨...');
                
                const tokenSelect = document.getElementById('token-select');
                const poolTokenSelect = document.getElementById('pool-token-select');
                
                // æ¸…ç©ºé€‰æ‹©å™¨
                tokenSelect.innerHTML = '<option value="">-- é€‰æ‹©ä»£å¸ --</option>';
                poolTokenSelect.innerHTML = '<option value="">-- é€‰æ‹©ä»£å¸ --</option>';

                // 1. è·å–AMMä¸­çš„ä»£å¸æ± 
                let poolTokens = [];
                try {
                    poolTokens = await simpleAMMContract.getAllPoolTokens();
                    console.log('AMMæ± ä¸­çš„ä»£å¸:', poolTokens);
                } catch (error) {
                    console.log('è·å–AMMæ± ä»£å¸å¤±è´¥:', error);
                }

                // 2. è·å–ç”¨æˆ·é€šè¿‡SimpleTokenFactoryåˆ›å»ºçš„çœŸå®ä»£å¸
                // æ³¨æ„ï¼šSimpleTokenFactoryåªè®°å½•åˆ›å»ºè¯·æ±‚ï¼ŒçœŸå®ä»£å¸éœ€è¦ç”¨æˆ·å•ç‹¬éƒ¨ç½²
                const userCreatedTokens = await getUserCreatedTokens();
                
                // 3. ä»localStorageè·å–ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„ä»£å¸
                const manualTokens = getManuallyAddedTokens();
                
                // 4. åˆå¹¶æ‰€æœ‰ä»£å¸åœ°å€
                const allTokens = [...new Set([...poolTokens, ...userCreatedTokens, ...manualTokens])];
                
                if (allTokens.length === 0) {
                    showNetworkStatus('warning', 'æ²¡æœ‰æ‰¾åˆ°å¯äº¤æ˜“çš„ä»£å¸');
                    return;
                }

                // 4. ä¸ºæ¯ä¸ªä»£å¸æ·»åŠ åˆ°é€‰æ‹©å™¨
                for (const tokenAddress of allTokens) {
                    try {
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                    const name = await tokenContract.name();
                    const symbol = await tokenContract.symbol();
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æµåŠ¨æ€§æ± 
                        let poolStatus = '';
                        try {
                            const poolInfo = await simpleAMMContract.getPoolInfo(tokenAddress);
                            poolStatus = poolInfo.exists ? ' âœ…' : ' âŒ';
                        } catch (error) {
                            poolStatus = ' âŒ';
                        }
                        
                    const option = document.createElement('option');
                    option.value = tokenAddress;
                        option.text = `${name} (${symbol})${poolStatus}`;
                        tokenSelect.appendChild(option.cloneNode(true));
                        
                        // ä¹Ÿæ·»åŠ åˆ°åˆ›å»ºæ± çš„é€‰æ‹©å™¨ï¼ˆåªæ·»åŠ æ²¡æœ‰æ± çš„ä»£å¸ï¼‰
                        if (poolStatus === ' âŒ') {
                            poolTokenSelect.appendChild(option);
                        }
                        
                    } catch (error) {
                        console.error(`è·å–ä»£å¸ä¿¡æ¯å¤±è´¥ ${tokenAddress}:`, error);
                    }
                }

                showNetworkStatus('success', `å·²åŠ è½½ ${allTokens.length} ä¸ªä»£å¸`);
                
            } catch (error) {
                console.error("åŠ è½½ä»£å¸å¤±è´¥:", error);
                showNetworkStatus('error', 'åŠ è½½ä»£å¸å¤±è´¥: ' + error.message);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¿æ¥é’±åŒ…æŒ‰é’®
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);

            // äº¤æ˜“ç±»å‹åˆ‡æ¢
            document.getElementById('buy-btn').addEventListener('click', function() {
                selectTradeType('buy');
            });

            document.getElementById('sell-btn').addEventListener('click', function() {
                selectTradeType('sell');
            });

            // ä»£å¸é€‰æ‹©
            document.getElementById('token-select').addEventListener('change', function() {
            const tokenAddress = this.value;
            if (tokenAddress) {
                    loadTokenInfo(tokenAddress);
                } else {
                    hideTokenInfo();
                }
            });

            // æ•°é‡è¾“å…¥
            document.getElementById('amount-input').addEventListener('input', function() {
                calculateEstimate();
            });

            // äº¤æ˜“æŒ‰é’®
            document.getElementById('trade-button').addEventListener('click', executeTrade);
        }

        // é€‰æ‹©äº¤æ˜“ç±»å‹
        function selectTradeType(type) {
            currentTradeType = type;
            
            const buyBtn = document.getElementById('buy-btn');
            const sellBtn = document.getElementById('sell-btn');
            const amountLabel = document.getElementById('amount-label');
            const inputCurrency = document.getElementById('input-currency');
            const outputCurrency = document.getElementById('output-currency');
            
            if (type === 'buy') {
                buyBtn.classList.add('active');
                sellBtn.classList.remove('active');
                amountLabel.textContent = 'è¾“å…¥ETHæ•°é‡';
                inputCurrency.textContent = 'ETH';
                outputCurrency.textContent = selectedToken ? selectedToken.symbol : 'Token';
            } else {
                sellBtn.classList.add('active');
                buyBtn.classList.remove('active');
                amountLabel.textContent = 'è¾“å…¥ä»£å¸æ•°é‡';
                inputCurrency.textContent = selectedToken ? selectedToken.symbol : 'Token';
                outputCurrency.textContent = 'ETH';
            }
            
            calculateEstimate();
        }

        // åŠ è½½ä»£å¸ä¿¡æ¯
        async function loadTokenInfo(tokenAddress) {
            try {
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                
                // è·å–åŸºç¡€ä¿¡æ¯
                const name = await tokenContract.name();
                const symbol = await tokenContract.symbol();
                const decimals = await tokenContract.decimals();
                
                // è·å–ç”¨æˆ·ä½™é¢
                let balance = '0';
                if (userAccount) {
                    const balanceWei = await tokenContract.balanceOf(userAccount);
                    balance = ethers.utils.formatUnits(balanceWei, decimals);
                }
                
                // è·å–æµåŠ¨æ€§æ± ä¿¡æ¯
                const poolInfo = await simpleAMMContract.getPoolInfo(tokenAddress);
                
                selectedToken = {
                    address: tokenAddress,
                    name: name,
                    symbol: symbol,
                    decimals: decimals,
                    balance: balance,
                    poolExists: poolInfo.exists,
                    tokenReserve: poolInfo.tokenReserve,
                    ethReserve: poolInfo.ethReserve
                };
                
                // æ˜¾ç¤ºä»£å¸ä¿¡æ¯
                document.getElementById('token-name').textContent = name;
                document.getElementById('token-symbol').textContent = symbol;
                document.getElementById('token-balance').textContent = balance + ' ' + symbol;
                document.getElementById('pool-status').textContent = poolInfo.exists ? 'âœ… å·²åˆ›å»º' : 'âŒ æœªåˆ›å»º';
                
                if (poolInfo.exists) {
                    // æ˜¾ç¤ºä»·æ ¼ä¿¡æ¯
                    document.getElementById('token-reserve').textContent = 
                        ethers.utils.formatUnits(poolInfo.tokenReserve, decimals) + ' ' + symbol;
                    document.getElementById('eth-reserve').textContent = 
                        ethers.utils.formatEther(poolInfo.ethReserve) + ' ETH';
                    
                    // è®¡ç®—ä»·æ ¼ (1 token = ? ETH)
                    const tokenPrice = poolInfo.ethReserve.mul(ethers.utils.parseUnits('1', decimals)).div(poolInfo.tokenReserve);
                    document.getElementById('token-price').textContent = 
                        ethers.utils.formatEther(tokenPrice) + ' ETH';
                    
                    document.getElementById('price-info').style.display = 'block';
                    document.getElementById('trade-button').disabled = false;
                } else {
                    document.getElementById('price-info').style.display = 'none';
                    document.getElementById('trade-button').disabled = true;
                }
                
                // æ˜¾ç¤ºé€‰ä¸­çš„ä»£å¸åç§°
                document.getElementById('selected-token-name').textContent = name;
                document.getElementById('selected-token-symbol').textContent = symbol;
                
                // æ˜¾ç¤ºæ‰€æœ‰é¢æ¿
                document.getElementById('token-info').style.display = 'block';
                document.getElementById('trade-panel').style.display = 'block';
                
                // æ›´æ–°äº¤æ˜“ç±»å‹æ˜¾ç¤º
                selectTradeType(currentTradeType);
                
            } catch (error) {
                console.error('åŠ è½½ä»£å¸ä¿¡æ¯å¤±è´¥:', error);
                showNetworkStatus('error', 'åŠ è½½ä»£å¸ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // éšè—ä»£å¸ä¿¡æ¯
        function hideTokenInfo() {
            document.getElementById('token-info').style.display = 'none';
            document.getElementById('price-info').style.display = 'none';
                document.getElementById('trade-panel').style.display = 'none';
            selectedToken = null;
        }

        // è®¡ç®—é¢„ä¼°è¾“å‡º
        function calculateEstimate() {
            if (!selectedToken || !selectedToken.poolExists) {
                document.getElementById('estimate-output').value = '';
                return;
            }

            const amountInput = document.getElementById('amount-input').value;
            if (!amountInput || parseFloat(amountInput) <= 0) {
                document.getElementById('estimate-output').value = '';
                return;
            }

            try {
            const FEE_RATE = 300;
            const FEE_DENOMINATOR = 100000;

                if (currentTradeType === 'buy') {
                    // è´­ä¹°ä»£å¸ï¼šETH -> Token
                    const ethAmount = ethers.utils.parseEther(amountInput);
                    const ethAmountWithFee = ethAmount.mul(FEE_DENOMINATOR - FEE_RATE).div(FEE_DENOMINATOR);
                    
                    const tokenOut = ethAmountWithFee.mul(selectedToken.tokenReserve).div(
                        selectedToken.ethReserve.add(ethAmountWithFee)
                    );
                    
                    document.getElementById('estimate-output').value = 
                        ethers.utils.formatUnits(tokenOut, selectedToken.decimals);
                        
            } else {
                    // å‡ºå”®ä»£å¸ï¼šToken -> ETH
                    const tokenAmount = ethers.utils.parseUnits(amountInput, selectedToken.decimals);
                    const tokenAmountWithFee = tokenAmount.mul(FEE_DENOMINATOR - FEE_RATE).div(FEE_DENOMINATOR);
                    
                    const ethOut = tokenAmountWithFee.mul(selectedToken.ethReserve).div(
                        selectedToken.tokenReserve.add(tokenAmountWithFee)
                    );
                    
                    document.getElementById('estimate-output').value = 
                        ethers.utils.formatEther(ethOut);
                }
            } catch (error) {
                console.error('è®¡ç®—é¢„ä¼°è¾“å‡ºå¤±è´¥:', error);
                document.getElementById('estimate-output').value = 'Error';
            }
        }

        // æ‰§è¡Œäº¤æ˜“
        async function executeTrade() {
            if (!selectedToken || !selectedToken.poolExists) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„ä»£å¸');
                return;
            }

            const amountInput = document.getElementById('amount-input').value;
            if (!amountInput || parseFloat(amountInput) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }

            const slippage = parseFloat(document.getElementById('slippage-select').value);
            
            try {
                showLoading(true);
                
                if (currentTradeType === 'buy') {
                    // è´­ä¹°ä»£å¸
                    const ethAmount = ethers.utils.parseEther(amountInput);
                    const estimateOutput = document.getElementById('estimate-output').value;
                    
                    if (!estimateOutput || estimateOutput === 'Error') {
                        throw new Error('æ— æ³•è®¡ç®—é¢„æœŸè¾“å‡º');
                    }
                    
                    const minTokenOut = ethers.utils.parseUnits(
                        (parseFloat(estimateOutput) * (100 - slippage) / 100).toString(),
                        selectedToken.decimals
                    );
                    
                    const tx = await simpleAMMContract.buyToken(selectedToken.address, minTokenOut, {
                        value: ethAmount
                    });
                    
                    await tx.wait();
                    
                    showSuccessResult('è´­ä¹°æˆåŠŸ', {
                        type: 'è´­ä¹°ä»£å¸',
                        input: `${amountInput} ETH`,
                        output: `~${estimateOutput} ${selectedToken.symbol}`,
                        txHash: tx.hash
                    });
                    
                } else {
                    // å‡ºå”®ä»£å¸
                    const tokenAmount = ethers.utils.parseUnits(amountInput, selectedToken.decimals);
                    const estimateOutput = document.getElementById('estimate-output').value;
                    
                    if (!estimateOutput || estimateOutput === 'Error') {
                        throw new Error('æ— æ³•è®¡ç®—é¢„æœŸè¾“å‡º');
                    }
                    
                    // æ£€æŸ¥æˆæƒ
                    const tokenContract = new ethers.Contract(selectedToken.address, ERC20_ABI, signer);
                    const allowance = await tokenContract.allowance(userAccount, NETWORK_CONFIG.contracts.SimpleAMM);
                    
                    if (allowance.lt(tokenAmount)) {
                        showNetworkStatus('info', 'éœ€è¦æˆæƒä»£å¸ï¼Œè¯·ç¡®è®¤æˆæƒäº¤æ˜“...');
                        const approveTx = await tokenContract.approve(NETWORK_CONFIG.contracts.SimpleAMM, tokenAmount);
                        await approveTx.wait();
                        showNetworkStatus('success', 'æˆæƒæˆåŠŸï¼Œæ‰§è¡Œäº¤æ˜“...');
                    }
                    
                    const minEthOut = ethers.utils.parseEther(
                        (parseFloat(estimateOutput) * (100 - slippage) / 100).toString()
                    );
                    
                    const tx = await simpleAMMContract.sellToken(selectedToken.address, tokenAmount, minEthOut);
                    await tx.wait();
                    
                    showSuccessResult('å‡ºå”®æˆåŠŸ', {
                        type: 'å‡ºå”®ä»£å¸',
                        input: `${amountInput} ${selectedToken.symbol}`,
                        output: `~${estimateOutput} ETH`,
                        txHash: tx.hash
                    });
                }
                
                // åˆ·æ–°æ•°æ®
                await loadTokenInfo(selectedToken.address);
                
            } catch (error) {
                console.error('äº¤æ˜“å¤±è´¥:', error);
                
                let errorMessage = 'äº¤æ˜“å¤±è´¥';
                if (error.message.includes('insufficient funds')) {
                    errorMessage = 'ä½™é¢ä¸è¶³';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.message.includes('slippage')) {
                    errorMessage = 'æ»‘ç‚¹è¿‡å¤§ï¼Œè¯·è°ƒæ•´æ»‘ç‚¹è®¾ç½®';
                } else {
                    errorMessage = 'äº¤æ˜“å¤±è´¥: ' + error.message;
                }
                
                showNetworkStatus('error', errorMessage);
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæ± æ¨¡æ€æ¡†
        function showCreatePoolModal() {
            const modal = new bootstrap.Modal(document.getElementById('createPoolModal'));
            modal.show();
        }

        // åˆ›å»ºæµåŠ¨æ€§æ± 
        async function createPool() {
            const tokenAddress = document.getElementById('pool-token-select').value;
            const tokenAmount = document.getElementById('pool-token-amount').value;
            const ethAmount = document.getElementById('pool-eth-amount').value;
            
            if (!tokenAddress || !tokenAmount || !ethAmount) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            try {
                showNetworkStatus('info', 'æ­£åœ¨åˆ›å»ºæµåŠ¨æ€§æ± ...');
                
                // è·å–ä»£å¸åˆçº¦
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                const decimals = await tokenContract.decimals();
                const tokenAmountWei = ethers.utils.parseUnits(tokenAmount, decimals);
                
                // æ£€æŸ¥æˆæƒ
                const allowance = await tokenContract.allowance(userAccount, NETWORK_CONFIG.contracts.SimpleAMM);
                if (allowance.lt(tokenAmountWei)) {
                    const approveTx = await tokenContract.approve(NETWORK_CONFIG.contracts.SimpleAMM, tokenAmountWei);
                    await approveTx.wait();
                }
                
                // åˆ›å»ºæ± 
                const tx = await simpleAMMContract.createPool(tokenAddress, tokenAmountWei, {
                    value: ethers.utils.parseEther(ethAmount)
                });
                
                await tx.wait();
                
                showNetworkStatus('success', 'æµåŠ¨æ€§æ± åˆ›å»ºæˆåŠŸï¼');
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ•°æ®
                bootstrap.Modal.getInstance(document.getElementById('createPoolModal')).hide();
                await loadAllTokens();
                
            } catch (error) {
                console.error('åˆ›å»ºæ± å¤±è´¥:', error);
                showNetworkStatus('error', 'åˆ›å»ºæ± å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            const tradeButton = document.getElementById('trade-button');
            
            if (show) {
                spinner.style.display = 'block';
                tradeButton.disabled = true;
                tradeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å¤„ç†ä¸­...';
            } else {
                spinner.style.display = 'none';
                tradeButton.disabled = false;
                tradeButton.innerHTML = '<i class="fas fa-exchange-alt me-2"></i>æ‰§è¡Œäº¤æ˜“';
            }
        }

        // æ˜¾ç¤ºæˆåŠŸç»“æœ
        function showSuccessResult(title, result) {
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultBody').innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                </div>
                <div class="row">
                    <div class="col-12 mb-2">
                        <strong>äº¤æ˜“ç±»å‹:</strong> ${result.type}
                    </div>
                    <div class="col-12 mb-2">
                        <strong>è¾“å…¥:</strong> ${result.input}
                    </div>
                    <div class="col-12 mb-2">
                        <strong>è¾“å‡º:</strong> ${result.output}
                    </div>
                    <div class="col-12 mb-3">
                        <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
                        <small class="font-monospace">${result.txHash}</small>
                        <br>
                        <a href="${NETWORK_CONFIG.explorer}/tx/${result.txHash}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-external-link-alt me-1"></i>åœ¨åŒºå—é“¾æµè§ˆå™¨æŸ¥çœ‹
                        </a>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
        function showNetworkStatus(type, message) {
            const statusDiv = document.getElementById('networkStatus');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 
                              type === 'info' ? 'alert-info' : 'alert-danger';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info' : 'times'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // æ›´æ–°è¿æ¥æŒ‰é’®
        function updateConnectButton(connected) {
            const btn = document.getElementById('connect-wallet');
            if (connected) {
                btn.textContent = 'å·²è¿æ¥';
                btn.className = 'btn btn-success';
            } else {
                btn.innerHTML = '<i class="fas fa-wallet me-2"></i>è¿æ¥é’±åŒ…';
                btn.className = 'btn btn-primary';
            }
        }

        // è·å–ç”¨æˆ·é€šè¿‡SimpleTokenFactoryåˆ›å»ºçš„ä»£å¸
        async function getUserCreatedTokens() {
            if (!userAccount || !simpleTokenFactoryContract) {
                return [];
            }
            
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä»äº‹ä»¶æ—¥å¿—è·å–ç”¨æˆ·åˆ›å»ºè¯·æ±‚çš„é€»è¾‘
                // ä½†ç”±äºSimpleTokenFactoryåªè®°å½•è¯·æ±‚ï¼Œä¸åŒ…å«å®é™…éƒ¨ç½²åœ°å€
                // æš‚æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ·»åŠ å·²éƒ¨ç½²çš„ä»£å¸
                return [];
            } catch (error) {
                console.error('è·å–ç”¨æˆ·åˆ›å»ºä»£å¸å¤±è´¥:', error);
                return [];
            }
        }

        // ä»localStorageè·å–æ‰‹åŠ¨æ·»åŠ çš„ä»£å¸
        function getManuallyAddedTokens() {
            try {
                const saved = localStorage.getItem('userTokens');
                const tokens = saved ? JSON.parse(saved) : [];
                // è¿”å›åœ°å€æ•°ç»„ä»¥ä¾¿ä¸å…¶ä»–ä»£å¸æ•°ç»„åˆå¹¶
                return tokens.map(token => token.address);
            } catch (error) {
                console.error('è·å–æœ¬åœ°ä»£å¸å¤±è´¥:', error);
                return [];
            }
        }

        // ä¿å­˜ä»£å¸åˆ°localStorage
        function saveTokenToLocal(address, info) {
            try {
                // è·å–å®Œæ•´çš„tokenå¯¹è±¡åˆ—è¡¨ï¼ˆä¸åªæ˜¯åœ°å€ï¼‰
                const saved = localStorage.getItem('userTokens');
                const tokens = saved ? JSON.parse(saved) : [];
                
                const tokenData = {
                    address: address,
                    name: info.name,
                    symbol: info.symbol,
                    addedAt: Date.now()
                };
                
                // é¿å…é‡å¤æ·»åŠ 
                if (!tokens.find(t => t.address.toLowerCase() === address.toLowerCase())) {
                    tokens.push(tokenData);
                    localStorage.setItem('userTokens', JSON.stringify(tokens));
                }
            } catch (error) {
                console.error('ä¿å­˜ä»£å¸å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ ä»£å¸æ¨¡æ€æ¡†
        function showAddTokenModal() {
            const modal = new bootstrap.Modal(document.getElementById('addTokenModal'));
            modal.show();
        }

        // éªŒè¯ä»£å¸
        async function verifyToken() {
            const input = document.getElementById('token-address-input').value.trim();
            const verificationDiv = document.getElementById('token-verification');
            const addBtn = document.getElementById('add-token-btn');
            
            if (!input) {
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = '<strong>é”™è¯¯:</strong> è¯·è¾“å…¥åˆçº¦åœ°å€æˆ–äº¤æ˜“å“ˆå¸Œ';
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }

            let address = input;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯äº¤æ˜“å“ˆå¸Œï¼ˆ66å­—ç¬¦ï¼‰è€Œä¸æ˜¯åœ°å€ï¼ˆ42å­—ç¬¦ï¼‰
            if (input.length === 66 && input.startsWith('0x')) {
                verificationDiv.className = 'alert alert-info';
                verificationDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æ£€æµ‹åˆ°äº¤æ˜“å“ˆå¸Œï¼Œæ­£åœ¨è·å–åˆçº¦åœ°å€...';
                verificationDiv.style.display = 'block';
                
                try {
                    const txReceipt = await provider.getTransactionReceipt(input);
                    if (!txReceipt) {
                        throw new Error('äº¤æ˜“ä¸å­˜åœ¨æˆ–å°šæœªç¡®è®¤');
                    }
                    
                    if (!txReceipt.contractAddress) {
                        throw new Error('æ­¤äº¤æ˜“æ²¡æœ‰åˆ›å»ºåˆçº¦');
                    }
                    
                    address = txReceipt.contractAddress;
                    verificationDiv.className = 'alert alert-success';
                    verificationDiv.innerHTML = `<strong>æ‰¾åˆ°åˆçº¦åœ°å€:</strong> ${address}`;
                } catch (error) {
                    console.error('ä»äº¤æ˜“å“ˆå¸Œè·å–åˆçº¦åœ°å€å¤±è´¥:', error);
                    verificationDiv.className = 'alert alert-danger';
                    verificationDiv.innerHTML = `<strong>é”™è¯¯:</strong> æ— æ³•ä»äº¤æ˜“å“ˆå¸Œè·å–åˆçº¦åœ°å€ - ${error.message}`;
                    verificationDiv.style.display = 'block';
                    addBtn.disabled = true;
                    return;
                }
            } else if (!ethers.utils.isAddress(address)) {
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = '<strong>é”™è¯¯:</strong> è¯·è¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€ï¼ˆ42å­—ç¬¦ï¼‰æˆ–äº¤æ˜“å“ˆå¸Œï¼ˆ66å­—ç¬¦ï¼‰';
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }
            
            // éªŒè¯æ˜¯å¦æ˜¯åˆçº¦
            try {
                const code = await provider.getCode(address);
                if (code === '0x') {
                    verificationDiv.className = 'alert alert-danger';
                    verificationDiv.innerHTML = '<strong>é”™è¯¯:</strong> è¯¥åœ°å€ä¸æ˜¯åˆçº¦åœ°å€';
                    verificationDiv.style.display = 'block';
                    addBtn.disabled = true;
                    return;
                }
            } catch (error) {
                console.error('æ£€æŸ¥åˆçº¦ä»£ç å¤±è´¥:', error);
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = `<strong>é”™è¯¯:</strong> æ— æ³•æ£€æŸ¥åˆçº¦ - ${error.message}`;
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }
            
            try {
                verificationDiv.className = 'alert alert-info';
                verificationDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨éªŒè¯ERC20ä»£å¸åˆçº¦...';
                verificationDiv.style.display = 'block';
                
                const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);
                
                // éªŒè¯ä»£å¸ä¿¡æ¯
                const [name, symbol, decimals, totalSupply] = await Promise.all([
                    tokenContract.name().catch(() => 'æœªçŸ¥'),
                    tokenContract.symbol().catch(() => 'æœªçŸ¥'), 
                    tokenContract.decimals().catch(() => 18),
                    tokenContract.totalSupply().catch(() => ethers.BigNumber.from(0))
                ]);
                
                verificationDiv.className = 'alert alert-success';
                verificationDiv.innerHTML = `
                    <h6><i class="fas fa-check-circle me-2"></i>ä»£å¸éªŒè¯æˆåŠŸ</h6>
                    <div class="row">
                        <div class="col-12 mb-2"><strong>åˆçº¦åœ°å€:</strong><br><small class="font-monospace">${address}</small></div>
                        <div class="col-6"><strong>åç§°:</strong> ${name}</div>
                        <div class="col-6"><strong>ç¬¦å·:</strong> ${symbol}</div>
                        <div class="col-6"><strong>ç²¾åº¦:</strong> ${decimals}</div>
                        <div class="col-6"><strong>æ€»ä¾›åº”:</strong> ${ethers.utils.formatUnits(totalSupply, decimals)}</div>
                    </div>
                `;
                verificationDiv.style.display = 'block';
                addBtn.disabled = false;
                
                // å­˜å‚¨éªŒè¯ç»“æœä»¥ä¾›æ·»åŠ æ—¶ä½¿ç”¨
                window.verifiedToken = {
                    address: address,
                    name: name,
                    symbol: symbol,
                    decimals: decimals
                };
                
            } catch (error) {
                console.error('éªŒè¯ä»£å¸å¤±è´¥:', error);
                let errorMsg = error.message;
                
                // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (errorMsg.includes('call revert exception')) {
                    errorMsg = 'åˆçº¦ä¸æ”¯æŒERC20æ ‡å‡†æ¥å£ï¼Œæˆ–è€…ç½‘ç»œè¿æ¥é—®é¢˜';
                } else if (errorMsg.includes('name')) {
                    errorMsg = 'æ— æ³•è·å–ä»£å¸åç§°ï¼Œå¯èƒ½ä¸æ˜¯æ ‡å‡†ERC20ä»£å¸';
                } else if (errorMsg.includes('symbol')) {
                    errorMsg = 'æ— æ³•è·å–ä»£å¸ç¬¦å·ï¼Œå¯èƒ½ä¸æ˜¯æ ‡å‡†ERC20ä»£å¸';
                }
                
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = `
                    <h6><strong>éªŒè¯å¤±è´¥</strong></h6>
                    <p><strong>é”™è¯¯:</strong> ${errorMsg}</p>
                    <p class="mb-0"><strong>å¯èƒ½åŸå› :</strong></p>
                    <ul class="mb-0">
                        <li>åˆçº¦æœªå®ç°æ ‡å‡†ERC20æ¥å£</li>
                        <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                        <li>åˆçº¦åœ°å€é”™è¯¯</li>
                        <li>åˆçº¦å°šæœªå®Œå…¨éƒ¨ç½²</li>
                    </ul>
                `;
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
            }
        }

        // æ·»åŠ ä»£å¸
        function addToken() {
            if (!window.verifiedToken) {
                alert('è¯·å…ˆéªŒè¯ä»£å¸');
                return;
            }
            
            try {
                saveTokenToLocal(window.verifiedToken.address, window.verifiedToken);
                showNetworkStatus('success', `ä»£å¸ ${window.verifiedToken.symbol} æ·»åŠ æˆåŠŸï¼`);
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ•°æ®
                bootstrap.Modal.getInstance(document.getElementById('addTokenModal')).hide();
                loadAllTokens();
                
                // æ¸…ç†
                document.getElementById('token-address-input').value = '';
                document.getElementById('token-verification').style.display = 'none';
                document.getElementById('add-token-btn').disabled = true;
                window.verifiedToken = null;
                
            } catch (error) {
                console.error('æ·»åŠ ä»£å¸å¤±è´¥:', error);
                showNetworkStatus('error', 'æ·»åŠ ä»£å¸å¤±è´¥: ' + error.message);
            }
        }

        // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    userAccount = null;
                    signer = null;
                    updateConnectButton(false);
                    hideTokenInfo();
                    showNetworkStatus('warning', 'é’±åŒ…å·²æ–­å¼€è¿æ¥');
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                window.location.reload();
            });
        }
    </script>
</body>
</html>