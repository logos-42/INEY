<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🪙 INEY 交易</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 多个ethers.js CDN源，确保加载成功 -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="text/javascript"></script>
    <script>
        // 如果ethers加载失败，使用备用CDN
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>');
        }
    </script>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #0052ff 0%, #1652f0 100%);
            color: white;
            padding: 60px 0;
        }
        .trade-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }
        .token-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .price-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .btn-primary-custom {
            background: linear-gradient(135deg, #0052ff 0%, #1652f0 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 8px;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 82, 255, 0.3);
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- 网络状态显示 -->
    <div id="networkStatus" class="network-status"></div>

    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">🪙 INEY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="create.html">创建代币</a></li>
                    <li class="nav-item"><a class="nav-link active" href="tread.html">交易</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">仪表板</a></li>
                </ul>
            </div>
            <button id="connect-wallet" class="btn btn-primary">连接钱包</button>
        </div>
    </nav>

    <!-- 英雄区域 -->
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-6 fw-bold mb-3">🚀 代币交易</h1>
            <p class="lead">在Base主网上交易个人代币</p>
        </div>
    </section>

    <!-- 交易界面 -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="trade-card">
                    <!-- 代币选择 -->
                    <div class="row mb-4">
            <div class="col-md-6">
                            <h5><i class="fas fa-coins me-2"></i>选择代币</h5>
                <select id="token-select" class="form-control">
                    <option value="">-- 选择代币 --</option>
                </select>
                            <div class="form-text">选择要交易的代币</div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-sync-alt me-2"></i>刷新数据</h5>
                            <button id="refresh-tokens" class="btn btn-outline-primary me-2" onclick="loadAllTokens()">
                                <i class="fas fa-refresh me-1"></i>刷新代币列表
                            </button>
                            <button id="create-test-pool" class="btn btn-outline-success me-2" onclick="showCreatePoolModal()">
                                <i class="fas fa-plus me-1"></i>创建测试池
                            </button>
                            <button class="btn btn-outline-info" onclick="showAddTokenModal()">
                                <i class="fas fa-coin me-1"></i>添加代币
                            </button>
            </div>
        </div>

                    <!-- 代币信息显示 -->
                    <div id="token-info" class="token-info" style="display: none;">
                        <h6><i class="fas fa-info-circle me-2"></i>代币信息</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>名称:</strong><br>
                                <span id="token-name">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>符号:</strong><br>
                                <span id="token-symbol">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>余额:</strong><br>
                                <span id="token-balance">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>流动性池:</strong><br>
                                <span id="pool-status">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 价格信息 -->
                    <div id="price-info" class="price-info" style="display: none;">
                        <h6><i class="fas fa-chart-line me-2"></i>价格信息</h6>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <strong>Token储备:</strong><br>
                                <span id="token-reserve">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>ETH储备:</strong><br>
                                <span id="eth-reserve">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>价格:</strong><br>
                                <span id="token-price">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 交易面板 -->
                    <div id="trade-panel" style="display: none;">
                        <h4 class="mb-3">交易 <span id="selected-token-name"></span> (<span id="selected-token-symbol"></span>)</h4>
                        
                        <!-- 交易类型选择 -->
                        <div class="form-group mb-3">
                            <label class="form-label">交易类型</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="buy-btn">
                                    <i class="fas fa-arrow-down me-1"></i>购买代币 (ETH → Token)
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="sell-btn">
                                    <i class="fas fa-arrow-up me-1"></i>出售代币 (Token → ETH)
                                </button>
                            </div>
                        </div>

                        <!-- 输入数量 -->
                        <div class="form-group mb-3">
                            <label id="amount-label" class="form-label">输入ETH数量</label>
                            <div class="input-group">
                                <input type="number" id="amount-input" class="form-control" placeholder="0.0" step="0.001" min="0">
                                <span class="input-group-text" id="input-currency">ETH</span>
                            </div>
                            <div class="form-text">输入要交易的数量</div>
                        </div>

                        <!-- 预估输出 -->
                        <div class="form-group mb-3">
                            <label class="form-label">预估获得</label>
                            <div class="input-group">
                        <input type="text" id="estimate-output" class="form-control" readonly>
                                <span class="input-group-text" id="output-currency">Token</span>
                            </div>
                            <div class="form-text">预计可以获得的数量（已扣除0.3%手续费）</div>
                        </div>

                        <!-- 滑点设置 -->
                        <div class="form-group mb-3">
                            <label class="form-label">滑点容忍度</label>
                            <select id="slippage-select" class="form-control">
                                <option value="0.5">0.5%</option>
                                <option value="1" selected>1%</option>
                                <option value="3">3%</option>
                                <option value="5">5%</option>
                            </select>
                        </div>

                        <!-- 执行交易按钮 -->
                        <button id="trade-button" class="btn btn-primary-custom w-100 mb-3" disabled>
                            <i class="fas fa-exchange-alt me-2"></i>执行交易
                        </button>

                        <!-- 加载状态 -->
                        <div class="loading-spinner" id="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">处理中...</span>
                            </div>
                            <p class="mt-3">正在处理交易，请稍候...</p>
                        </div>
                    </div>

                                         <!-- 提示信息 -->
                     <div class="alert alert-warning">
                         <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>重要说明</h6>
                         <ul class="mb-0">
                             <li>请先连接MetaMask钱包并确保在Base主网</li>
                             <li>您的SimpleTokenFactory(0x09F8...f468)只记录代币创建请求</li>
                             <li>实际代币需要您单独部署，然后使用"添加代币"功能添加</li>
                             <li>只添加通过您的系统创建的代币，避免安全风险</li>
                             <li>交易需要支付0.3%的手续费</li>
                             <li>建议设置适当的滑点容忍度</li>
                         </ul>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建流动性池模态框 -->
    <div class="modal fade" id="createPoolModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建测试流动性池</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>注意:</strong> 这将使用真实的ETH创建流动性池！
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">选择代币</label>
                        <select id="pool-token-select" class="form-control">
                            <option value="">-- 选择代币 --</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">代币数量</label>
                        <input type="number" id="pool-token-amount" class="form-control" placeholder="1000" min="1">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">ETH数量</label>
                        <input type="number" id="pool-eth-amount" class="form-control" placeholder="0.001" step="0.001" min="0.001">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createPool()">创建池</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加代币模态框 -->
    <div class="modal fade" id="addTokenModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加真实代币</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>重要说明</h6>
                        <ul class="mb-0">
                            <li>SimpleTokenFactory只记录代币创建请求</li>
                            <li>实际代币需要您单独部署</li>
                            <li>请确保代币地址是通过您的系统创建的</li>
                            <li>添加不明代币存在安全风险</li>
                        </ul>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">代币合约地址</label>
                        <input type="text" id="token-address-input" class="form-control" placeholder="0x..." maxlength="42">
                        <div class="form-text">输入已部署的代币合约地址</div>
                    </div>
                    <div id="token-verification" class="alert" style="display: none;">
                        <!-- 代币验证结果 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info" onclick="verifyToken()">验证代币</button>
                    <button type="button" class="btn btn-primary" onclick="addToken()" disabled id="add-token-btn">添加代币</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易结果模态框 -->
    <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultTitle">交易结果</h5>
                </div>
                <div class="modal-body" id="resultBody">
                    <!-- 结果内容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="location.reload()">继续交易</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 网络配置
        const NETWORK_CONFIG = {
            chainId: 8453,
            name: "Base Mainnet",
            rpcUrl: "https://mainnet.base.org",
            explorer: "https://basescan.org",
            contracts: {
                SimpleTokenFactory: "0x09F80281c90d574B4C5769cf2308ea4B70b4f468",
                PersonalToken: "0xd3F54d1e5909a8ae1E15DBf1e27825e716B26d0E",
                SimpleAMM: "0x8C53A213B97B52989BCCE04fE306464e6767BC75"
            }
        };

        // 合约ABI
        const SIMPLE_TOKEN_FACTORY_ABI = [
            "function totalTokensCreated() external view returns (uint256)",
            "function getUserTokenCount(address user) external view returns (uint256)",
            "function creationFee() external view returns (uint256)",
            "function requestTokenCreation(string memory _name, string memory _symbol, uint256 _initialSupply) external payable returns (bool)"
        ];

        const SIMPLE_AMM_ABI = [
            "function getAllPoolTokens() external view returns (address[])",
            "function getPoolInfo(address token) external view returns (uint256 tokenReserve, uint256 ethReserve, uint256 totalLiquidity, bool exists)",
            "function buyToken(address token, uint256 minTokenOut) external payable",
            "function sellToken(address token, uint256 tokenAmount, uint256 minEthOut) external",
            "function createPool(address token, uint256 tokenAmount) external payable",
            "function getPrice(address token) external view returns (uint256 tokenPrice, uint256 ethPrice)",
            "function getAmountOut(uint256 amountIn, uint256 reserveIn, uint256 reserveOut) external pure returns (uint256)"
        ];

        const ERC20_ABI = [
            "function name() external view returns (string)",
            "function symbol() external view returns (string)",
            "function decimals() external view returns (uint8)",
            "function totalSupply() external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function transfer(address to, uint256 amount) external returns (bool)"
        ];

        let provider, signer, userAccount;
        let simpleTokenFactoryContract, simpleAMMContract;
        let currentTradeType = 'buy';
        let selectedToken = null;

        // 确保ethers库加载完成后再初始化
        function initializeApp() {
            if (typeof ethers === 'undefined') {
                console.error('ethers库未加载，等待重试...');
                setTimeout(initializeApp, 500);
                return;
            }
            
            console.log('ethers库加载成功，版本:', ethers.version);
            initializeWeb3();
            setupEventListeners();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 100);
        });

        // 初始化Web3
        async function initializeWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // 检查是否已连接
                    const accounts = await window.ethereum.request({method: 'eth_accounts'});
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('初始化Web3失败:', error);
                    showNetworkStatus('error', '初始化失败: ' + error.message);
                }
            } else {
                showNetworkStatus('warning', '请安装MetaMask钱包');
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNetworkStatus('error', '请安装MetaMask钱包');
                    return;
                }

                console.log('开始连接钱包...');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (!accounts || accounts.length === 0) {
                    showNetworkStatus('error', '没有找到账户，请检查MetaMask');
                    return;
                }
                
                userAccount = accounts[0];
                
                if (!provider) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                
                try {
                signer = provider.getSigner();
                } catch (signerError) {
                    console.error('获取Signer失败:', signerError);
                    showNetworkStatus('error', '获取签名器失败: ' + signerError.message);
                    return;
                }

                // 检查网络
                try {
                const network = await provider.getNetwork();
                    
                if (network.chainId !== NETWORK_CONFIG.chainId) {
                        await switchToBaseMainnet();
                        return;
                    }
                } catch (networkError) {
                    console.error('获取网络信息失败:', networkError);
                    showNetworkStatus('warning', '无法获取网络信息，请检查连接');
                }
                
                // 初始化合约实例
                try {
                    simpleTokenFactoryContract = new ethers.Contract(
                        NETWORK_CONFIG.contracts.SimpleTokenFactory,
                        SIMPLE_TOKEN_FACTORY_ABI,
                        provider
                    );
                    
                    simpleAMMContract = new ethers.Contract(
                        NETWORK_CONFIG.contracts.SimpleAMM,
                        SIMPLE_AMM_ABI,
                        signer
                    );
                } catch (contractError) {
                    console.error('创建合约实例失败:', contractError);
                    showNetworkStatus('error', '创建合约实例失败: ' + contractError.message);
                    return;
                }
                
                showNetworkStatus('success', `已连接: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}`);
                updateConnectButton(true);
                
                // 加载代币数据
                await loadAllTokens();
                
            } catch (error) {
                console.error('连接钱包详细错误:', error);
                
                let errorMessage = '连接失败';
                if (error.code === 4001) {
                    errorMessage = '用户拒绝了连接请求';
                } else if (error.code === -32002) {
                    errorMessage = 'MetaMask正在处理请求，请等待';
                } else if (error.message) {
                    errorMessage = '连接失败: ' + error.message;
                } else {
                    errorMessage = '连接失败: 未知错误';
                }
                
                showNetworkStatus('error', errorMessage);
            }
        }

        // 切换到Base主网
        async function switchToBaseMainnet() {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + NETWORK_CONFIG.chainId.toString(16) }],
                        });
                
                setTimeout(connectWallet, 1000);
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await addBaseMainnetNetwork();
                } else {
                    throw switchError;
                }
            }
        }

        // 添加Base主网
        async function addBaseMainnetNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x' + NETWORK_CONFIG.chainId.toString(16),
                        chainName: NETWORK_CONFIG.name,
                        nativeCurrency: {
                            name: 'ETH',
                            symbol: 'ETH',
                            decimals: 18,
                        },
                        rpcUrls: [NETWORK_CONFIG.rpcUrl],
                        blockExplorerUrls: [NETWORK_CONFIG.explorer],
                    }],
                });
                
                setTimeout(connectWallet, 1000);
                
            } catch (error) {
                console.error('添加网络失败:', error);
                showNetworkStatus('error', '添加网络失败: ' + error.message);
            }
        }

        // 加载所有代币
        async function loadAllTokens() {
            if (!provider || !simpleAMMContract) {
                showNetworkStatus('warning', '请先连接钱包');
                return;
            }

            try {
                showNetworkStatus('info', '正在加载代币列表...');
                
                const tokenSelect = document.getElementById('token-select');
                const poolTokenSelect = document.getElementById('pool-token-select');
                
                // 清空选择器
                tokenSelect.innerHTML = '<option value="">-- 选择代币 --</option>';
                poolTokenSelect.innerHTML = '<option value="">-- 选择代币 --</option>';

                // 1. 获取AMM中的代币池
                let poolTokens = [];
                try {
                    poolTokens = await simpleAMMContract.getAllPoolTokens();
                    console.log('AMM池中的代币:', poolTokens);
                } catch (error) {
                    console.log('获取AMM池代币失败:', error);
                }

                // 2. 获取用户通过SimpleTokenFactory创建的真实代币
                // 注意：SimpleTokenFactory只记录创建请求，真实代币需要用户单独部署
                const userCreatedTokens = await getUserCreatedTokens();
                
                // 3. 从localStorage获取用户手动添加的代币
                const manualTokens = getManuallyAddedTokens();
                
                // 4. 合并所有代币地址
                const allTokens = [...new Set([...poolTokens, ...userCreatedTokens, ...manualTokens])];
                
                if (allTokens.length === 0) {
                    showNetworkStatus('warning', '没有找到可交易的代币');
                    return;
                }

                // 4. 为每个代币添加到选择器
                for (const tokenAddress of allTokens) {
                    try {
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                    const name = await tokenContract.name();
                    const symbol = await tokenContract.symbol();
                        
                        // 检查是否有流动性池
                        let poolStatus = '';
                        try {
                            const poolInfo = await simpleAMMContract.getPoolInfo(tokenAddress);
                            poolStatus = poolInfo.exists ? ' ✅' : ' ❌';
                        } catch (error) {
                            poolStatus = ' ❌';
                        }
                        
                    const option = document.createElement('option');
                    option.value = tokenAddress;
                        option.text = `${name} (${symbol})${poolStatus}`;
                        tokenSelect.appendChild(option.cloneNode(true));
                        
                        // 也添加到创建池的选择器（只添加没有池的代币）
                        if (poolStatus === ' ❌') {
                            poolTokenSelect.appendChild(option);
                        }
                        
                    } catch (error) {
                        console.error(`获取代币信息失败 ${tokenAddress}:`, error);
                    }
                }

                showNetworkStatus('success', `已加载 ${allTokens.length} 个代币`);
                
            } catch (error) {
                console.error("加载代币失败:", error);
                showNetworkStatus('error', '加载代币失败: ' + error.message);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 连接钱包按钮
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);

            // 交易类型切换
            document.getElementById('buy-btn').addEventListener('click', function() {
                selectTradeType('buy');
            });

            document.getElementById('sell-btn').addEventListener('click', function() {
                selectTradeType('sell');
            });

            // 代币选择
            document.getElementById('token-select').addEventListener('change', function() {
            const tokenAddress = this.value;
            if (tokenAddress) {
                    loadTokenInfo(tokenAddress);
                } else {
                    hideTokenInfo();
                }
            });

            // 数量输入
            document.getElementById('amount-input').addEventListener('input', function() {
                calculateEstimate();
            });

            // 交易按钮
            document.getElementById('trade-button').addEventListener('click', executeTrade);
        }

        // 选择交易类型
        function selectTradeType(type) {
            currentTradeType = type;
            
            const buyBtn = document.getElementById('buy-btn');
            const sellBtn = document.getElementById('sell-btn');
            const amountLabel = document.getElementById('amount-label');
            const inputCurrency = document.getElementById('input-currency');
            const outputCurrency = document.getElementById('output-currency');
            
            if (type === 'buy') {
                buyBtn.classList.add('active');
                sellBtn.classList.remove('active');
                amountLabel.textContent = '输入ETH数量';
                inputCurrency.textContent = 'ETH';
                outputCurrency.textContent = selectedToken ? selectedToken.symbol : 'Token';
            } else {
                sellBtn.classList.add('active');
                buyBtn.classList.remove('active');
                amountLabel.textContent = '输入代币数量';
                inputCurrency.textContent = selectedToken ? selectedToken.symbol : 'Token';
                outputCurrency.textContent = 'ETH';
            }
            
            calculateEstimate();
        }

        // 加载代币信息
        async function loadTokenInfo(tokenAddress) {
            try {
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                
                // 获取基础信息
                const name = await tokenContract.name();
                const symbol = await tokenContract.symbol();
                const decimals = await tokenContract.decimals();
                
                // 获取用户余额
                let balance = '0';
                if (userAccount) {
                    const balanceWei = await tokenContract.balanceOf(userAccount);
                    balance = ethers.utils.formatUnits(balanceWei, decimals);
                }
                
                // 获取流动性池信息
                const poolInfo = await simpleAMMContract.getPoolInfo(tokenAddress);
                
                selectedToken = {
                    address: tokenAddress,
                    name: name,
                    symbol: symbol,
                    decimals: decimals,
                    balance: balance,
                    poolExists: poolInfo.exists,
                    tokenReserve: poolInfo.tokenReserve,
                    ethReserve: poolInfo.ethReserve
                };
                
                // 显示代币信息
                document.getElementById('token-name').textContent = name;
                document.getElementById('token-symbol').textContent = symbol;
                document.getElementById('token-balance').textContent = balance + ' ' + symbol;
                document.getElementById('pool-status').textContent = poolInfo.exists ? '✅ 已创建' : '❌ 未创建';
                
                if (poolInfo.exists) {
                    // 显示价格信息
                    document.getElementById('token-reserve').textContent = 
                        ethers.utils.formatUnits(poolInfo.tokenReserve, decimals) + ' ' + symbol;
                    document.getElementById('eth-reserve').textContent = 
                        ethers.utils.formatEther(poolInfo.ethReserve) + ' ETH';
                    
                    // 计算价格 (1 token = ? ETH)
                    const tokenPrice = poolInfo.ethReserve.mul(ethers.utils.parseUnits('1', decimals)).div(poolInfo.tokenReserve);
                    document.getElementById('token-price').textContent = 
                        ethers.utils.formatEther(tokenPrice) + ' ETH';
                    
                    document.getElementById('price-info').style.display = 'block';
                    document.getElementById('trade-button').disabled = false;
                } else {
                    document.getElementById('price-info').style.display = 'none';
                    document.getElementById('trade-button').disabled = true;
                }
                
                // 显示选中的代币名称
                document.getElementById('selected-token-name').textContent = name;
                document.getElementById('selected-token-symbol').textContent = symbol;
                
                // 显示所有面板
                document.getElementById('token-info').style.display = 'block';
                document.getElementById('trade-panel').style.display = 'block';
                
                // 更新交易类型显示
                selectTradeType(currentTradeType);
                
            } catch (error) {
                console.error('加载代币信息失败:', error);
                showNetworkStatus('error', '加载代币信息失败: ' + error.message);
            }
        }

        // 隐藏代币信息
        function hideTokenInfo() {
            document.getElementById('token-info').style.display = 'none';
            document.getElementById('price-info').style.display = 'none';
                document.getElementById('trade-panel').style.display = 'none';
            selectedToken = null;
        }

        // 计算预估输出
        function calculateEstimate() {
            if (!selectedToken || !selectedToken.poolExists) {
                document.getElementById('estimate-output').value = '';
                return;
            }

            const amountInput = document.getElementById('amount-input').value;
            if (!amountInput || parseFloat(amountInput) <= 0) {
                document.getElementById('estimate-output').value = '';
                return;
            }

            try {
            const FEE_RATE = 300;
            const FEE_DENOMINATOR = 100000;

                if (currentTradeType === 'buy') {
                    // 购买代币：ETH -> Token
                    const ethAmount = ethers.utils.parseEther(amountInput);
                    const ethAmountWithFee = ethAmount.mul(FEE_DENOMINATOR - FEE_RATE).div(FEE_DENOMINATOR);
                    
                    const tokenOut = ethAmountWithFee.mul(selectedToken.tokenReserve).div(
                        selectedToken.ethReserve.add(ethAmountWithFee)
                    );
                    
                    document.getElementById('estimate-output').value = 
                        ethers.utils.formatUnits(tokenOut, selectedToken.decimals);
                        
            } else {
                    // 出售代币：Token -> ETH
                    const tokenAmount = ethers.utils.parseUnits(amountInput, selectedToken.decimals);
                    const tokenAmountWithFee = tokenAmount.mul(FEE_DENOMINATOR - FEE_RATE).div(FEE_DENOMINATOR);
                    
                    const ethOut = tokenAmountWithFee.mul(selectedToken.ethReserve).div(
                        selectedToken.tokenReserve.add(tokenAmountWithFee)
                    );
                    
                    document.getElementById('estimate-output').value = 
                        ethers.utils.formatEther(ethOut);
                }
            } catch (error) {
                console.error('计算预估输出失败:', error);
                document.getElementById('estimate-output').value = 'Error';
            }
        }

        // 执行交易
        async function executeTrade() {
            if (!selectedToken || !selectedToken.poolExists) {
                alert('请选择有效的代币');
                return;
            }

            const amountInput = document.getElementById('amount-input').value;
            if (!amountInput || parseFloat(amountInput) <= 0) {
                alert('请输入有效的数量');
                return;
            }

            const slippage = parseFloat(document.getElementById('slippage-select').value);
            
            try {
                showLoading(true);
                
                if (currentTradeType === 'buy') {
                    // 购买代币
                    const ethAmount = ethers.utils.parseEther(amountInput);
                    const estimateOutput = document.getElementById('estimate-output').value;
                    
                    if (!estimateOutput || estimateOutput === 'Error') {
                        throw new Error('无法计算预期输出');
                    }
                    
                    const minTokenOut = ethers.utils.parseUnits(
                        (parseFloat(estimateOutput) * (100 - slippage) / 100).toString(),
                        selectedToken.decimals
                    );
                    
                    const tx = await simpleAMMContract.buyToken(selectedToken.address, minTokenOut, {
                        value: ethAmount
                    });
                    
                    await tx.wait();
                    
                    showSuccessResult('购买成功', {
                        type: '购买代币',
                        input: `${amountInput} ETH`,
                        output: `~${estimateOutput} ${selectedToken.symbol}`,
                        txHash: tx.hash
                    });
                    
                } else {
                    // 出售代币
                    const tokenAmount = ethers.utils.parseUnits(amountInput, selectedToken.decimals);
                    const estimateOutput = document.getElementById('estimate-output').value;
                    
                    if (!estimateOutput || estimateOutput === 'Error') {
                        throw new Error('无法计算预期输出');
                    }
                    
                    // 检查授权
                    const tokenContract = new ethers.Contract(selectedToken.address, ERC20_ABI, signer);
                    const allowance = await tokenContract.allowance(userAccount, NETWORK_CONFIG.contracts.SimpleAMM);
                    
                    if (allowance.lt(tokenAmount)) {
                        showNetworkStatus('info', '需要授权代币，请确认授权交易...');
                        const approveTx = await tokenContract.approve(NETWORK_CONFIG.contracts.SimpleAMM, tokenAmount);
                        await approveTx.wait();
                        showNetworkStatus('success', '授权成功，执行交易...');
                    }
                    
                    const minEthOut = ethers.utils.parseEther(
                        (parseFloat(estimateOutput) * (100 - slippage) / 100).toString()
                    );
                    
                    const tx = await simpleAMMContract.sellToken(selectedToken.address, tokenAmount, minEthOut);
                    await tx.wait();
                    
                    showSuccessResult('出售成功', {
                        type: '出售代币',
                        input: `${amountInput} ${selectedToken.symbol}`,
                        output: `~${estimateOutput} ETH`,
                        txHash: tx.hash
                    });
                }
                
                // 刷新数据
                await loadTokenInfo(selectedToken.address);
                
            } catch (error) {
                console.error('交易失败:', error);
                
                let errorMessage = '交易失败';
                if (error.message.includes('insufficient funds')) {
                    errorMessage = '余额不足';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = '用户取消了交易';
                } else if (error.message.includes('slippage')) {
                    errorMessage = '滑点过大，请调整滑点设置';
                } else {
                    errorMessage = '交易失败: ' + error.message;
                }
                
                showNetworkStatus('error', errorMessage);
            } finally {
                showLoading(false);
            }
        }

        // 显示创建池模态框
        function showCreatePoolModal() {
            const modal = new bootstrap.Modal(document.getElementById('createPoolModal'));
            modal.show();
        }

        // 创建流动性池
        async function createPool() {
            const tokenAddress = document.getElementById('pool-token-select').value;
            const tokenAmount = document.getElementById('pool-token-amount').value;
            const ethAmount = document.getElementById('pool-eth-amount').value;
            
            if (!tokenAddress || !tokenAmount || !ethAmount) {
                alert('请填写所有字段');
                return;
            }
            
            try {
                showNetworkStatus('info', '正在创建流动性池...');
                
                // 获取代币合约
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                const decimals = await tokenContract.decimals();
                const tokenAmountWei = ethers.utils.parseUnits(tokenAmount, decimals);
                
                // 检查授权
                const allowance = await tokenContract.allowance(userAccount, NETWORK_CONFIG.contracts.SimpleAMM);
                if (allowance.lt(tokenAmountWei)) {
                    const approveTx = await tokenContract.approve(NETWORK_CONFIG.contracts.SimpleAMM, tokenAmountWei);
                    await approveTx.wait();
                }
                
                // 创建池
                const tx = await simpleAMMContract.createPool(tokenAddress, tokenAmountWei, {
                    value: ethers.utils.parseEther(ethAmount)
                });
                
                await tx.wait();
                
                showNetworkStatus('success', '流动性池创建成功！');
                
                // 关闭模态框并刷新数据
                bootstrap.Modal.getInstance(document.getElementById('createPoolModal')).hide();
                await loadAllTokens();
                
            } catch (error) {
                console.error('创建池失败:', error);
                showNetworkStatus('error', '创建池失败: ' + error.message);
            }
        }

        // 显示加载状态
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            const tradeButton = document.getElementById('trade-button');
            
            if (show) {
                spinner.style.display = 'block';
                tradeButton.disabled = true;
                tradeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';
            } else {
                spinner.style.display = 'none';
                tradeButton.disabled = false;
                tradeButton.innerHTML = '<i class="fas fa-exchange-alt me-2"></i>执行交易';
            }
        }

        // 显示成功结果
        function showSuccessResult(title, result) {
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultBody').innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                </div>
                <div class="row">
                    <div class="col-12 mb-2">
                        <strong>交易类型:</strong> ${result.type}
                    </div>
                    <div class="col-12 mb-2">
                        <strong>输入:</strong> ${result.input}
                    </div>
                    <div class="col-12 mb-2">
                        <strong>输出:</strong> ${result.output}
                    </div>
                    <div class="col-12 mb-3">
                        <strong>交易哈希:</strong><br>
                        <small class="font-monospace">${result.txHash}</small>
                        <br>
                        <a href="${NETWORK_CONFIG.explorer}/tx/${result.txHash}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-external-link-alt me-1"></i>在区块链浏览器查看
                        </a>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        // 显示网络状态
        function showNetworkStatus(type, message) {
            const statusDiv = document.getElementById('networkStatus');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 
                              type === 'info' ? 'alert-info' : 'alert-danger';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info' : 'times'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // 更新连接按钮
        function updateConnectButton(connected) {
            const btn = document.getElementById('connect-wallet');
            if (connected) {
                btn.textContent = '已连接';
                btn.className = 'btn btn-success';
            } else {
                btn.innerHTML = '<i class="fas fa-wallet me-2"></i>连接钱包';
                btn.className = 'btn btn-primary';
            }
        }

        // 获取用户通过SimpleTokenFactory创建的代币
        async function getUserCreatedTokens() {
            if (!userAccount || !simpleTokenFactoryContract) {
                return [];
            }
            
            try {
                // 这里可以添加从事件日志获取用户创建请求的逻辑
                // 但由于SimpleTokenFactory只记录请求，不包含实际部署地址
                // 暂时返回空数组，用户需要手动添加已部署的代币
                return [];
            } catch (error) {
                console.error('获取用户创建代币失败:', error);
                return [];
            }
        }

        // 从localStorage获取手动添加的代币
        function getManuallyAddedTokens() {
            try {
                const saved = localStorage.getItem('userTokens');
                const tokens = saved ? JSON.parse(saved) : [];
                // 返回地址数组以便与其他代币数组合并
                return tokens.map(token => token.address);
            } catch (error) {
                console.error('获取本地代币失败:', error);
                return [];
            }
        }

        // 保存代币到localStorage
        function saveTokenToLocal(address, info) {
            try {
                // 获取完整的token对象列表（不只是地址）
                const saved = localStorage.getItem('userTokens');
                const tokens = saved ? JSON.parse(saved) : [];
                
                const tokenData = {
                    address: address,
                    name: info.name,
                    symbol: info.symbol,
                    addedAt: Date.now()
                };
                
                // 避免重复添加
                if (!tokens.find(t => t.address.toLowerCase() === address.toLowerCase())) {
                    tokens.push(tokenData);
                    localStorage.setItem('userTokens', JSON.stringify(tokens));
                }
            } catch (error) {
                console.error('保存代币失败:', error);
            }
        }

        // 显示添加代币模态框
        function showAddTokenModal() {
            const modal = new bootstrap.Modal(document.getElementById('addTokenModal'));
            modal.show();
        }

        // 验证代币
        async function verifyToken() {
            const input = document.getElementById('token-address-input').value.trim();
            const verificationDiv = document.getElementById('token-verification');
            const addBtn = document.getElementById('add-token-btn');
            
            if (!input) {
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = '<strong>错误:</strong> 请输入合约地址或交易哈希';
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }

            let address = input;
            
            // 检查是否是交易哈希（66字符）而不是地址（42字符）
            if (input.length === 66 && input.startsWith('0x')) {
                verificationDiv.className = 'alert alert-info';
                verificationDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>检测到交易哈希，正在获取合约地址...';
                verificationDiv.style.display = 'block';
                
                try {
                    const txReceipt = await provider.getTransactionReceipt(input);
                    if (!txReceipt) {
                        throw new Error('交易不存在或尚未确认');
                    }
                    
                    if (!txReceipt.contractAddress) {
                        throw new Error('此交易没有创建合约');
                    }
                    
                    address = txReceipt.contractAddress;
                    verificationDiv.className = 'alert alert-success';
                    verificationDiv.innerHTML = `<strong>找到合约地址:</strong> ${address}`;
                } catch (error) {
                    console.error('从交易哈希获取合约地址失败:', error);
                    verificationDiv.className = 'alert alert-danger';
                    verificationDiv.innerHTML = `<strong>错误:</strong> 无法从交易哈希获取合约地址 - ${error.message}`;
                    verificationDiv.style.display = 'block';
                    addBtn.disabled = true;
                    return;
                }
            } else if (!ethers.utils.isAddress(address)) {
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = '<strong>错误:</strong> 请输入有效的合约地址（42字符）或交易哈希（66字符）';
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }
            
            // 验证是否是合约
            try {
                const code = await provider.getCode(address);
                if (code === '0x') {
                    verificationDiv.className = 'alert alert-danger';
                    verificationDiv.innerHTML = '<strong>错误:</strong> 该地址不是合约地址';
                    verificationDiv.style.display = 'block';
                    addBtn.disabled = true;
                    return;
                }
            } catch (error) {
                console.error('检查合约代码失败:', error);
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = `<strong>错误:</strong> 无法检查合约 - ${error.message}`;
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
                return;
            }
            
            try {
                verificationDiv.className = 'alert alert-info';
                verificationDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在验证ERC20代币合约...';
                verificationDiv.style.display = 'block';
                
                const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);
                
                // 验证代币信息
                const [name, symbol, decimals, totalSupply] = await Promise.all([
                    tokenContract.name().catch(() => '未知'),
                    tokenContract.symbol().catch(() => '未知'), 
                    tokenContract.decimals().catch(() => 18),
                    tokenContract.totalSupply().catch(() => ethers.BigNumber.from(0))
                ]);
                
                verificationDiv.className = 'alert alert-success';
                verificationDiv.innerHTML = `
                    <h6><i class="fas fa-check-circle me-2"></i>代币验证成功</h6>
                    <div class="row">
                        <div class="col-12 mb-2"><strong>合约地址:</strong><br><small class="font-monospace">${address}</small></div>
                        <div class="col-6"><strong>名称:</strong> ${name}</div>
                        <div class="col-6"><strong>符号:</strong> ${symbol}</div>
                        <div class="col-6"><strong>精度:</strong> ${decimals}</div>
                        <div class="col-6"><strong>总供应:</strong> ${ethers.utils.formatUnits(totalSupply, decimals)}</div>
                    </div>
                `;
                verificationDiv.style.display = 'block';
                addBtn.disabled = false;
                
                // 存储验证结果以供添加时使用
                window.verifiedToken = {
                    address: address,
                    name: name,
                    symbol: symbol,
                    decimals: decimals
                };
                
            } catch (error) {
                console.error('验证代币失败:', error);
                let errorMsg = error.message;
                
                // 提供更友好的错误信息
                if (errorMsg.includes('call revert exception')) {
                    errorMsg = '合约不支持ERC20标准接口，或者网络连接问题';
                } else if (errorMsg.includes('name')) {
                    errorMsg = '无法获取代币名称，可能不是标准ERC20代币';
                } else if (errorMsg.includes('symbol')) {
                    errorMsg = '无法获取代币符号，可能不是标准ERC20代币';
                }
                
                verificationDiv.className = 'alert alert-danger';
                verificationDiv.innerHTML = `
                    <h6><strong>验证失败</strong></h6>
                    <p><strong>错误:</strong> ${errorMsg}</p>
                    <p class="mb-0"><strong>可能原因:</strong></p>
                    <ul class="mb-0">
                        <li>合约未实现标准ERC20接口</li>
                        <li>网络连接问题</li>
                        <li>合约地址错误</li>
                        <li>合约尚未完全部署</li>
                    </ul>
                `;
                verificationDiv.style.display = 'block';
                addBtn.disabled = true;
            }
        }

        // 添加代币
        function addToken() {
            if (!window.verifiedToken) {
                alert('请先验证代币');
                return;
            }
            
            try {
                saveTokenToLocal(window.verifiedToken.address, window.verifiedToken);
                showNetworkStatus('success', `代币 ${window.verifiedToken.symbol} 添加成功！`);
                
                // 关闭模态框并刷新数据
                bootstrap.Modal.getInstance(document.getElementById('addTokenModal')).hide();
                loadAllTokens();
                
                // 清理
                document.getElementById('token-address-input').value = '';
                document.getElementById('token-verification').style.display = 'none';
                document.getElementById('add-token-btn').disabled = true;
                window.verifiedToken = null;
                
            } catch (error) {
                console.error('添加代币失败:', error);
                showNetworkStatus('error', '添加代币失败: ' + error.message);
            }
        }

        // 监听账户和网络变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    userAccount = null;
                    signer = null;
                    updateConnectButton(false);
                    hideTokenInfo();
                    showNetworkStatus('warning', '钱包已断开连接');
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                window.location.reload();
            });
        }
    </script>
</body>
</html>